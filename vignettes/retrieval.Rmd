---
title: "Example Data Retrieval Workflow"
author: "Mark Hagemann"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Introduction

This document details an example data retrieval workflow. The steps are:

1. select input parameters for WQP request
    - where (bounding box)
    - what (characteristic name, characteristic type)
2. Make WQP request
3. Perform checks on retrieved data
    - Accounting of columns and classes
    - Remove undesired fractions
    - Address units reported (optionally convert these)
    - Address detection limits and try to infer where missing.
    


### Get input parameters

```{r}
bb1 <- bbox(-80, 38, -77, 40, plot = TRUE)

inputChars <- charNameLookup("alumin")
flowChars <- bind_rows(charNameLookup("flow"),
                       charNameLookup("discharge"))

inputChars
flowChars
```


### Make WQP request

```{r}
aluminumData <- getConcData(bBox = bb1, charname = inputChars$value)
```

### Perform checks

```{r}
alData <- aluminumData %>% 
  wqp_checkClasses() %>% 
  wqp_checkActivity() %>% 
  wqp_checkFraction() %>% 
  wqp_checkUnits(convertTo = c("mg/l", "mg/kg")) %>% 
  wqp_checkBDL()
```


### Get flow data

```{r}

flowsites <- unique(alData$MonitoringLocationIdentifier)
flowData <- getFlowData(flowsites)

summary(as.factor(flowData$ActivityTypeCode))
summary(as.factor(flowData$ResultMeasure.MeasureUnitCode))
qData <- flowData %>% 
  wqp_checkActivity() %>% 
  wqp_checkUnits(convertTo = "cfs") %>% 
  wqp_checkBDL()
summary(as.factor(qData$ActivityTypeCode))
summary(as.factor(qData$ResultMeasure.MeasureUnitCode))
```

Get single flow observation for each day.

```{r}
maxPerDay <- function(df) {
  max(summary(as.factor(df$ActivityStartDate)))
  which.max(summary(as.factor(df$ActivityStartDate)))
  
}
df <- flowData_good[[3]]
df[df$ActivityStartDate == "2008-06-16", "ActivityTypeCode"]
```

Some are quality control replicates

```{r}
lapply(flowData_good, function(x) unique(x$ActivityTypeCode)) %>% 
  unlist %>% 
  as.factor() %>% 
  summary()
```

Add to workflow the omission of "quality control" activity types.

```{r}

all(sapply(flowData_good, ncol) == 65)

#' Takes an object returned by readWQPData (or getConcData) and returns an
#' object of class rcData
#'
wqpToRcData <- function(concData, flowData) {
  
  knownTypes <- c("Sample-Routine", "Sample", "Not determined",
                  "Field Msr/Obs", "Sample-Composite Without Parents")
  
  # Omit quality control samples
  concData <- concData[!grepl("Quality Control", concData$ActivityTypeCode), ]
  unrecTypes_conc <- setdiff(concData$ActivityTypeCode, knownTypes)
  if(length(unrecTypes_conc) > 0)
    warning(paste("Unknown activity types present in conc data:", 
                  paste(unrecTypes_conc, collapse = "; ")))
  flowData <- flowData[!grepl("Quality Control", flowData$ActivityTypeCode), ]
  unrecTypes_flow <- setdiff(flowData$ActivityTypeCode, knownTypes)
  if(length(unrecTypes_flow) > 0)
    warning(paste("Unknown activity types present in flow data:", 
                  paste(unrecTypes_flow, collapse = "; ")))

  # Make sure all columns are accounted for
  # Calculate BDLs
  
}


```



### Convert to rcData

1. Make preliminary data.frame with columns Date, flow, flow.units, conc, conc.units, is.bdl


```{r}

rcDatas <- lapply()
```


### Fix getConcData to always give same columns and classes DONE. Made wqp_checkClasses function

```{r}
classDF <- function(df) 
  as.data.frame(lapply(df, function(obj) paste(class(obj), collapse = ";")))
classes <- lapply(flowData_good, classDF) %>% 
  bind_rows()

glimpse(classes)
dim(classes)
dim(unique(classes))

glimpse(unique(classes))

datecols <- names(aluminumData)[grepl("Date$", names(aluminumData))]

notDate <- sapply(flowData_good, function(df) class(df[[datecols[4]]]) != "Date") %>% 
  which()
notDate

```

### Deal with units

```{r}
unique(aluminumData$ResultMeasure.MeasureUnitCode)
# Which are in percent?

which(aluminumData$ResultMeasure.MeasureUnitCode == "%")
aluminumData[10330, ] %>% glimpse
dataRetrieval::pCodeToName %>% filter(parm_cd == "30221")

which(aluminumData$ResultMeasure.MeasureUnitCode == "mg/kg")
aluminumData[3430, ] %>% glimpse
dataRetrieval::pCodeToName %>% filter(parm_cd == "01108")

# So is the problem bed sediment?
aluminumData$ResultSampleFractionText %>% unique

```

Make function convertToMg_L 

