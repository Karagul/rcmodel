---
title: "Example Data Retrieval Workflow"
author: "Mark Hagemann"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Introduction

This document details an example data retrieval workflow. The steps are:

1. select input parameters for WQP request
    - where (bounding box)
    - what (characteristic name, characteristic type)
2. Make WQP request
3. Perform checks on retrieved data
    - Accounting of columns and classes
    - Remove undesired "activity" (e.g. quality control samples)
    - Remove undesired fractions
    - Look up missing units, optionally convert these
    - Address detection limits and try to infer where missing.
    


### Get input parameters

```{r}
bb1 <- bbox(-80, 38, -77, 40, plot = TRUE)

inputChars <- charNameLookup("nitrate")
flowChars <- bind_rows(charNameLookup("flow"),
                       charNameLookup("discharge"))

inputChars
print(flowChars, n = 30)
```


### Make WQP request

```{r}
(nitrChars <- inputChars[c(4, 5, 6, 8), ])

nitrateData <- timeit(getConcData(bBox = bb1, charname = nitrChars$value))
dim(nitrateData)

```

### Perform checks

```{r}
no3Data <- nitrateData %>% 
  wqp_checkClasses() %>% 
  wqp_checkActivity() %>% 
  wqp_checkFraction() %>% 
  wqp_checkUnits(convertTo = c("mg/l", "mg/l as N", "meq/l", "mg/kg"),
                 inconvertibles = "omit") %>% 
  wqp_checkBDL()
```


### Get flow data

```{r}
flowsites <- unique(no3Data$MonitoringLocationIdentifier)
no3Flow <- timeit(getFlowData(flowsites, n = 100))

qData <- no3Flow %>% 
  wqp_checkActivity() %>% 
  wqp_checkUnits(convertTo = "cfs") %>% 
  wqp_checkBDL()

```

Get single flow observation for each day.

```{r}
nPerDay <- no3Data %>% 
  group_by(MonitoringLocationIdentifier,
           CharacteristicName, ActivityStartDate,
           ResultMeasure.MeasureUnitCode,
           ResultSampleFractionText) %>% 
  summarize(n = n(), minq = min(ResultMeasureValue), maxq = max(ResultMeasureValue)) %>% 
  ungroup() %>% 
  arrange(desc(n))
print(nPerDay, n = 100)

qData %>% 
  filter(MonitoringLocationIdentifier == "211WVOWR-P-004-0002") %>% 
  transmute(Date = ActivityStartDate, datetime = ActivityStartDateTime,
            value = ResultMeasureValue, units = ResultMeasure.MeasureUnitCode) %>% 
  arrange(datetime) %>% 
  ggplot(aes(x = datetime, y = value)) +
  geom_point()

qData %>% 
  filter(MonitoringLocationIdentifier == "USGS-01639000",
         # ResultMeasure.MeasureUnitCode == "mg/l",
         # ResultSampleFractionText == "Dissolved",
         ActivityStartDate == "1993-12-05") %>%
  transmute(Date = ActivityStartDate, datetime = ActivityStartDateTime,
            value = ResultMeasureValue, units = ResultMeasure.MeasureUnitCode) %>% 
  arrange(datetime) %>% 
  ggplot(aes(x = datetime, y = value)) +
  geom_point()


```


### Convert to rcData

```{r}
no3Simple <- wqp_simplifyConc(no3Data)
qSimple <- wqp_simplifyFlow(qData)

glimpse(no3Simple)

rawdat <- full_join()

rcd <- makeModelData()
```


