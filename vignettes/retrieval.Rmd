---
title: "Example Data Retrieval Workflow"
author: "Mark Hagemann"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Introduction

This document details an example data retrieval workflow. The steps are:

1. select input parameters for WQP request
    - where (bounding box)
    - what (characteristic name, characteristic type)
2. Make WQP request
3. Perform checks on retrieved data
    - Accounting of columns and classes
    - Remove undesired "activity" (e.g. quality control samples)
    - Remove undesired fractions
    - Look up missing units, optionally convert these
    - Address detection limits and try to infer where missing.
    


### Get input parameters

```{r}
bb1 <- bbox(-80, 38, -77, 40, plot = TRUE)

inputChars <- charNameLookup("nitrate")
flowChars <- bind_rows(charNameLookup("flow"),
                       charNameLookup("discharge"))

inputChars
print(flowChars, n = 30)
```


### Make WQP request

```{r}
(nitrChars <- inputChars[c(4, 5, 6, 8), ])

nitrateData <- timeit(getConcData(bBox = bb1, charname = nitrChars$value))
dim(nitrateData)
```

### Perform checks

```{r}
library(dplyr)

no3Data <- nitrateData %>% 
  wqp_checkClasses() %>% 
  wqp_checkActivity() %>% 
  wqp_checkFraction() %>% 
  wqp_checkUnits(convertTo = c("mg/l", "mg/l as N", "meq/l", "mg/kg"),
                 inconvertibles = "omit") %>% 
  wqp_checkBDL() %>% 
  wqp_checkDuplicates()
```


### Get flow data

```{r}
flowsites <- unique(no3Data$MonitoringLocationIdentifier)
no3Flow <- timeit(getFlowData(flowsites, n = 100))

qData <- no3Flow %>% 
  wqp_checkClasses() %>% 
  wqp_checkActivity() %>% 
  wqp_checkUnits(convertTo = "cfs") %>% 
  wqp_checkBDL() %>% 
  wqp_checkDuplicates()
```

Simplify to daily resolution.

```{r}
no3Simple <- wqp_simplifyConc(no3Data, average = "time")
qSimple <- wqp_simplifyFlow(qData, average = "time")
```


### Convert to rcData

unlike the wqp datasets, each rcData object is specific to a location and characteristic. Therefore, the result of converting a simplified wqp dataset to rcData will be a list of rcData objects.

```{r}
rcDataList <- makeRcData(simpleConc = no3Simple, simpleFlow = qSimple)

nobs <- sapply(rcDataList, nrow)
nbdl <- sapply(rcDataList, function(df) sum(df$is.bdl))

rcDataList <- rcDataList[nobs >= 30 & nbdl == 0]

```

Now we can easily make rating curve models using these datasets.

```{r}
no3Models <- lapply(rcDataList, loadest_cal)
length(no3Models)

sapply(no3Models, markstats::R2) %>% summary
```

OK! Calling it a day. Git commit and quit. 
